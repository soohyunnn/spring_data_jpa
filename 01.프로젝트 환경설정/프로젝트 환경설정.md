# í”„ë¡œì íŠ¸ í™˜ê²½ì„¤ì •

## í”„ë¡œì íŠ¸ ìƒì„±

```java
Project: Gradle - Groovy Project
Language: Java
Spring Boot: 3.1.x

Group: study
Artifact: data-jpa
Name: data-jpa
Package name: study.data-jpa
Packing: **Jar**
Java: 17

Dependencies: Web, Jpa, H2 Database, Lombok
```

- ìŠ¤í”„ë§ ë¶€íŠ¸ ë©”ì¸ ì‹¤í–‰ í›„ ë™ì‘ í™•ì¸ (`[http://localhost:8080](http://localhost:8080)`)
- í…ŒìŠ¤íŠ¸ ì»¨íŠ¸ë¡¤ëŸ¬ ë§Œë“¤ì–´ì„œ spring web ë™ì‘ í™•ì¸ ([`http://localhost:8080/hello`](http://localhost:8080/hello))

**í…ŒìŠ¤íŠ¸ ì»¨íŠ¸ë¡¤ëŸ¬**

```java
package study.datajpa.controller;

import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class HelloController {

    @RequestMapping("/hello")
    public String hello() {
        return "hello";
    }
}
```

## ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚´í´ë³´ê¸°

### gradle ì˜ì¡´ê´€ê³„ ë³´ê¸°

`./gradlew dependencies --configuration compileClasspath`

### ìŠ¤í”„ë§ ë¶€íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚´í´ë³´ê¸°

- spring-boot-starter-web
    - spring-boot-starter-tomcat: í†°ìº£ (ì›¹ì„œë²„)
    - spring-webmvc: ìŠ¤í”„í•‘ ì›¹ MVC
- spring-boot-starter-data-jpa
    - spring-boot-starter-aop
    - spring-boot-starter-jdbc
        - HikariCP ì»¤ë„¥ì…˜ í’€ (ë¶€íŠ¸ 2.0 ê¸°ë³¸)
    - hibernate + JPA: í•˜ì´ë²„ë„¤ì´íŠ¸ + JPA
    - spring-data-jpa: ìŠ¤í”„ë§ ë°ì´í„° JPA
- spring-boot-starter(ê³µí†µ): ìŠ¤í”„ë§ ë¶€íŠ¸ + ìŠ¤í”„ë§ ì½”ì–´ + ë¡œê¹…
    - spring-boot
        - spring-core
    - spring-boot-starter-logging
        - logback, slf4j

### í…ŒìŠ¤íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬

- spring-boot-starter-test
    - junit: í…ŒìŠ¤íŠ¸ í”„ë ˆì„ì›Œí¬, ìŠ¤í”„ë§ ë¶€íŠ¸ 2.2ë¶€í„° junit5(`jupiter`)ì‚¬ìš©
        - ê³¼ê±° ë²„ì „ì€ vintage
    - mockito: ëª© ë¼ì´ë¸ŒëŸ¬ë¦¬
    - assertj: í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì¢€ ë” í¸í•˜ê²Œ ì‘ì„±í•˜ê²Œ ë„ì™€ì£¼ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬
        - [`https://joel-costigliola.github.io/assertj/index.html`](https://joel-costigliola.github.io/assertj/index.html)
    - spring-test: ìŠ¤í”„ë§ í†µí•© í…ŒìŠ¤íŠ¸ ì§€ì›
- í•µì‹¬ ë¼ì´ë¸ŒëŸ¬ë¦¬
    - ìŠ¤í”„ë§ MVC
    - ìŠ¤í”„ë§ ORM
    - JPA, í•˜ì´ë²„ë„¤ì´íŠ¸
    - ìŠ¤í”„ë§ ë°ì´í„° JPA
- ê¸°íƒ€ ë¼ì´ë¸ŒëŸ¬ë¦¬
    - H2 ë°ì´í„°ë² ì´ìŠ¤ í´ë¼ì´ì–¸íŠ¸
    - ì»¤ë„¥ì…˜ í’€: ë¶€íŠ¸ ê¸°ë³¸ì€ HikariCP
    - ë¡œê¹… SLF4J & LogBack
    - í…ŒìŠ¤íŠ¸

## H2 ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì¹˜

- `https://www.h2database.com`
- ë‹¤ìš´ë¡œë“œ ë° ì„¤ì¹˜
- h2 ë°ì´í„°ë² ì´ìŠ¤ ë²„ì „ì€ ìŠ¤í”„ë§ ë¶€íŠ¸ ë²„ì „ì— ë§ì¶˜ë‹¤.
- ê¶Œí•œ ì£¼ê¸°: `chmod 755 h2.sh`
- ë°ì´í„°ë² ì´ìŠ¤ íŒŒì¼ ìƒì„± ë°©ë²•
    - `jdbc:h2:~/datajpa` (ìµœì†Œ í•œë²ˆ)
    - `~/datajpa.mv.db` íŒŒì¼ ìƒì„± í™•ì¸
    - ì´í›„ ë¶€í„°ëŠ” `jdbc:h2:tcp://localhost/~/datajpa` ì´ë ‡ê²Œ ì ‘ì†

> ì°¸ê³ : H2 ë°ì´í„°ë² ì´ìŠ¤ì˜ MVCC ì˜µì…˜ì€ H2 1.4.198 ë²„ì „ë¶€í„° ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤. ì‚¬ìš© ë²„ì „ì´ 1.4.199ì´ë¯€ë¡œ ì˜µì…˜ ì—†ì´ ì‚¬ìš©í•˜ë©´ ë©ë‹ˆë‹¤.
> 

## ìŠ¤í”„ë§ ë°ì´í„° JPAì™€ DB ì„¤ì •, ë™ì‘í™•ì¸

### ì„¤ì •

`application.properties`

```java
spring.datasource.url=jdbc:h2:tcp://localhost/~/DataJpa
spring.datasource.username=sa
spring.datasource.password=
spring.datasource.driver-class-name=org.h2.Driver

spring.jpa.hibernate.ddl-auto=create
#spring.jpa.properties.hibernate.show_sql=true
spring.jpa.properties.hibernate.format_sql=true

logging.level.org.hibernate.SQL=debug
#logging.level.org.hibernate.type=trace
```

â†’ datajpa ë¶€ë¶„ì—ì„œ ì˜ë¯¸ìˆëŠ” ì˜ì–´ë‹¨ì–´ê°€ ì•„ë‹Œ ë‹¨ì–´ë¥¼ ì†Œë¬¸ìë¡œ ë‚˜ì—´í•  ê²½ìš° typoë¡œ ì¸ì‹í•œë‹¤.

ğŸ‘‡Â DB ì ‘ì† ì£¼ì†ŒëŠ” ì†Œë¬¸ìë¡œ ë˜ì–´ìˆë‹¤.

![Untitled](https://github.com/soohyunnn/spring_data_jpa/assets/58289675/5a1d9710-6399-4da3-ab2e-413acd318cbd)

- spring.jpa.hibernate.ddl-auto: create
    - ì´ ì˜µì…˜ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ ì‹œì ì— í…Œì´ë¸”ì„ drop í•˜ê³ , ë‹¤ì‹œ ìƒì„±í•œë‹¤.

> ğŸ’¡Â ì°¸ê³  : ëª¨ë“  ë¡œê·¸ ì¶œë ¥ì€ ê°€ê¸‰ì  ë¡œê±°ë¥¼ í†µí•´ ë‚¨ê²¨ì•¼ í•œë‹¤.
`show_sql` : ì˜µì…˜ì€ `System.out`ì— í•˜ì´ë²„ë„¤ì´íŠ¸ ì‹¤í–‰ SQLì„ ë‚¨ê¸´ë‹¤.
`org.hibernate.SQL` : ì˜µì…˜ì€ loggerë¥¼ í†µí•´ í•˜ì´ë²„ë„¤ì´íŠ¸ ì‹¤í–‰ SQLì„ ë‚¨ê¸´ë‹¤.
> 

### **ì´ì œ ì‹¤ì œ ë™ì‘í•˜ëŠ”ì§€ ì•„ë˜ ì½”ë“œë¥¼ ì‘ì„± í›„ ì‹¤í–‰í•´ë³´ì.**

**íšŒì› ì—”í‹°í‹°**

```java
package study.datajpa.entity;

import jakarta.persistence.Entity;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.Id;
import lombok.Getter;
import lombok.Setter;

@Entity
@Getter
@Setter
public class Member {

    @Id @GeneratedValue
    private Long id;
    private String username;

    protected Member() {
    }

    public Member(String username) {
        this.username = username;
    }
}
```

**íšŒì› JPA ë¦¬í¬ì§€í† ë¦¬**

```java
package study.datajpa.repository;

import jakarta.persistence.EntityManager;
import jakarta.persistence.PersistenceContext;
import org.springframework.stereotype.Repository;
import study.datajpa.entity.Member;

@Repository
public class MemberJpaRepository {

    @PersistenceContext
    private EntityManager em;

    public Member save(Member member) {
        em.persist(member);
        return member;
    }

    public Member find(Long id) {
        return em.find(Member.class, id);
    }

}
```

**JPA ê¸°ë°˜ í…ŒìŠ¤íŠ¸**

```java
package study.datajpa.repository;

import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.annotation.Rollback;
import org.springframework.transaction.annotation.Transactional;
import study.datajpa.entity.Member;

import static org.assertj.core.api.Assertions.assertThat;
import static org.junit.jupiter.api.Assertions.*;

@SpringBootTest
@Transactional
@Rollback(false)
class MemberJpaRepositoryTest {

    @Autowired
    MemberJpaRepository memberJpaRepository;

    @Test
    public void testMember() {
        Member member = new Member("memberA");
        Member savedMember = memberJpaRepository.save(member);

        Member findMember = memberJpaRepository.find(savedMember.getId());

        assertThat(findMember.getId()).isEqualTo(member.getId());
        assertThat(findMember.getUsername()).isEqualTo(member.getUsername());

        assertThat(findMember).isEqualTo(member);
    }

}
```

**ìŠ¤í”„ë§ ë°ì´í„° JPA ë¦¬í¬ì§€í† ë¦¬**

```java
package study.datajpa.repository;

import org.springframework.data.jpa.repository.JpaRepository;
import study.datajpa.entity.Member;

public interface MemberRepository extends JpaRepository<Member, Long> {
}
```

**ìŠ¤í”„ë§ ë°ì´í„° JPA ê¸°ë°˜ í…ŒìŠ¤íŠ¸**

```java
package study.datajpa.repository;

import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.annotation.Rollback;
import org.springframework.transaction.annotation.Transactional;
import study.datajpa.entity.Member;

import static org.assertj.core.api.Assertions.assertThat;
import static org.junit.jupiter.api.Assertions.*;

@SpringBootTest
@Transactional
@Rollback(false)
class MemberRepositoryTest {

    @Autowired
    MemberRepository memberRepository;

    @Test
    public void testMember() {
        Member member = new Member("memberA");
        Member savedMember = memberRepository.save(member);

        Member findMember = memberRepository.findById(savedMember.getId()).get();

        assertThat(findMember.getId()).isEqualTo(member.getId());
        assertThat(findMember.getUsername()).isEqualTo(member.getUsername());

        assertThat(findMember).isEqualTo(member);  //JPA ì—”í‹°í‹° ë™ì¼ì„± ë³´ì¥
    }

}
```

- Entity, Repository ë™ì‘ í™•ì¸
- jar ë¹Œë“œí•´ì„œ ë™ì‘ í™•ì¸

> ğŸ’¡Â ì°¸ê³  
: ìŠ¤í”„ë§ ë¶€íŠ¸ë¥¼ í†µí•´ ë³µì¡í•œ ì„¤ì •ì´ ë‹¤ ìë™í™” ë˜ì—ˆë‹¤. `persistence.xml`ë„ ì—†ê³ , `LocalContainerEntityManagerBean`ë„ ì—†ë‹¤. ìŠ¤í”„ë§ ë¶€íŠ¸ë¥¼ í†µí•œ ì¶”ê°€ ì„¤ì •ì€ ìŠ¤í”„ë§ ë¶€íŠ¸ ë©”ë‰´ì–¼ì„ ì°¸ê³ í•˜ê³ , ìŠ¤í”„ë§ ë¶€íŠ¸ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  ìˆœìˆ˜ ìŠ¤í”„ë§ê³¼ JPA ì„¤ì • ë°©ë²•ì€ ìë°” ORM í‘œì¤€ JPA í”„ë¡œê·¸ë˜ë° ì±…ì„ ì°¸ê³ í•˜ì.
> 

### ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¡œ ë¡œê·¸ ë‚¨ê¸°ê¸°

- ë¡œê·¸ì— ë‹¤ìŒì„ ì¶”ê°€í•˜ê¸° org.hibernate.type: SQL ì‹¤í–‰ íŒŒë¼ë¯¸í„°ë¥¼ ë¡œê·¸ë¡œ ë‚¨ê¸´ë‹¤.
- ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš©
    - https://github.com/gavlyukovskiy/spring-boot-data-source-decorator

ìŠ¤í”„ë§ ë¶€íŠ¸ë¥¼ ì‚¬ìš©í•˜ë©´ ì´ ë¼ì´ë¸ŒëŸ¬ë¦¬ë§Œ ì¶”ê°€í•˜ë©´ ëœë‹¤.

```java
implementation 'com.github.gavlyukovskiy:p6spy-spring-boot-starter:1.5.7'
```

ğŸ’¡Â ì°¸ê³ : ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¥¼ ë¡œê·¸ë¡œ ë‚¨ê¸°ëŠ” ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” ì‹œìŠ¤í…œ ìì›ì„ ì‚¬ìš©í•˜ë¯€ë¡œ, ê°œë°œ ë‹¨ê³„ì—ì„œëŠ” í¸í•˜ê²Œ ì‚¬ìš©í•´ë„ ëœë‹¤. í•˜ì§€ë§Œ ìš´ì˜ì‹œìŠ¤í…œì— ì ìš©í•˜ë ¤ë©´ ê¼­ ì„±ëŠ¥í…ŒìŠ¤íŠ¸ë¥¼ í•˜ê³  ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤.

### ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ë¡œê·¸ ë‚¨ê¸°ê¸° - ìŠ¤í”„ë§ ë¶€íŠ¸ 3.0

ìŠ¤í”„ë§ ë¶€íŠ¸ 3.0 ì´ìƒì„ ì‚¬ìš©í•˜ë©´ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë²„ì „ì„ 1.9.0 ì´ìƒì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤.

```java
implementation 'com.github.gavlyukovskiy:p6spy-spring-boot-starter:1.9.0'
```