# ì¿¼ë¦¬ ë©”ì†Œë“œ ê¸°ëŠ¥

ì¿¼ë¦¬ ë©”ì†Œë“œ ê¸°ëŠ¥ 3ê°€ì§€

- ë©”ì†Œë“œ ì´ë¦„ìœ¼ë¡œ ì¿¼ë¦¬ ìƒì„±
- ë©”ì†Œë“œ ì´ë¦„ìœ¼ë¡œ JPA NamedQuery í˜¸ì¶œ
- @Query ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•´ì„œ ë¦¬í¬ì§€í† ë¦¬ ì¸í„°í˜ì´ìŠ¤ì— ì¿¼ë¦¬ ì§ì ‘ ì •ì˜

## ë©”ì†Œë“œ ì´ë¦„ìœ¼ë¡œ ì¿¼ë¦¬ ìƒì„±

ë©”ì†Œë“œ ì´ë¦„ì„ ë¶„ì„í•´ì„œ JPQL ì¿¼ë¦¬ ì‹¤í–‰í•˜ëŠ”ë°â€¦ ë§Œì•½ ì´ë¦„ê³¼ ë‚˜ì´ë¥¼ ê¸°ì¤€ìœ¼ë¡œ íšŒì›ì„ ì¡°íšŒí•˜ë ¤ë©´?

**ìˆœìˆ˜ JPA ë¦¬í¬ì§€í† ë¦¬ -** MemberJpaRepository

```java
public List<Member> findByUsernameAndGreaterThan(String username, int age) {
    return em.createQuery("select m from Member m where m.username = :username and m.age > :age")
            .setParameter("username", username)
            .setParameter("age", age)
            .getResultList();
}
```

**ìˆœìˆ˜ JPA í…ŒìŠ¤íŠ¸ ì½”ë“œ -** MemberJpaRepositoryTest

```java
@Test
public void findByUsernameAndAgeGreaterThan() {
    Member m1 = new Member("AAA", 10);
    Member m2 = new Member("AAA", 20);
    memberJpaRepository.save(m1);
    memberJpaRepository.save(m2);

    List<Member> result = memberJpaRepository.findByUsernameAndGreaterThan("AAA", 15);
    assertThat(result.get(0).getUsername()).isEqualTo("AAA");
    assertThat(result.get(0).getAge()).isEqualTo(20);
    assertThat(result.size()).isEqualTo(1);
}
```

**ìŠ¤í”„ë§ ë°ì´í„° JPA**

```java
package study.datajpa.repository;

import org.springframework.data.jpa.repository.JpaRepository;
import study.datajpa.entity.Member;

import java.util.List;

public interface MemberRepository extends JpaRepository<Member, Long> {

    List<Member> findByUsernameAndAgeGreaterThan(String username, int age);
    
}
```

- ìŠ¤í”„ë§ ë°ì´í„° JPAëŠ” ë©”ì†Œë“œ ì´ë¦„ì„ ë¶„ì„í•´ì„œ JPQLì„ ìƒì„±í•˜ê³  ì‹¤í–‰

**ì¿¼ë¦¬ ë©”ì†Œë“œ í•„í„° ì¡°ê±´**

ìŠ¤í”„ë§ ë°ì´í„° JPA ê³µì‹ ë¬¸ì„œ ì°¸ê³  ğŸ‘‡

[Spring Data JPA - Reference Documentation](https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#jpa.query-methods.query-creation)

**ìŠ¤í”„ë§ ë°ì´í„° JPAê°€ ì œê³µí•˜ëŠ” ì¿¼ë¦¬ ë©”ì†Œë“œ ê¸°ëŠ¥**

- ì¡°íšŒ : findâ€¦By, readâ€¦By, queryâ€¦By, getâ€¦By,
    
    [Spring Data JPA - Reference Documentation](https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#repositories.query-methods.query-creation)
    
    - ì˜ˆ) findHelloBy ì²˜ëŸ¼ â€¦ì— ì‹ë³„í•˜ê¸° ìœ„í•œ ë‚´ìš©(ì„¤ëª…)ì´ ë“¤ì–´ê°€ë„ ëœë‹¤.
- COUNT: countâ€¦By ë°˜í™˜íƒ€ì… `long`
- EXISTS : exists..By ë°˜í™˜íƒ€ì… `boolean`
- ì‚­ì œ : deleteâ€¦By, removeâ€¦By ë°˜í™˜íƒ€ì… `long`
- DISTINCT : findDistinct, findMemberDistinctBy
- LIMIT : findFirst3, findFirst, findTop, findTop3
    
    [Spring Data JPA - Reference Documentation](https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#repositories.limit-query-result)
    

> ğŸ’¡ì°¸ê³  : ì´ ê¸°ëŠ¥ì€ ì—”í‹°í‹°ì˜ í•„ë“œëª…ì´ ë³€ê²½ë˜ë©´ ì¸í„°í˜ì´ìŠ¤ì— ì •ì˜í•œ ë©”ì„œë“œ ì´ë¦„ë„ ê¼­ í•¨ê»˜ ë³€ê²½í•´ì•¼ í•œë‹¤.
ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‹œì‘í•˜ëŠ” ì‹œì ì— ì˜¤ë¥˜ê°€ ë°œìƒí•œë‹¤.
ì´ë ‡ê²Œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œë”© ì‹œì ì— ì˜¤ë¥˜ë¥¼ ì¸ì§€í•  ìˆ˜ ìˆëŠ” ê²ƒì´ ìŠ¤í”„ë§ ë°ì´í„° JPAì˜ ë§¤ìš° í° ì¥ì ì´ë‹¤.
> 

## JPA NamedQuery

JPAì˜ NamedQueryë¥¼ í˜¸ì¶œí•  ìˆ˜ ìˆìŒ

**`@NamedQuery` ì–´ë…¸í…Œì´ì…˜ìœ¼ë¡œ Named ì¿¼ë¦¬ ì •ì˜**

```java
package study.datajpa.entity;

import jakarta.persistence.*;
import lombok.*;

@Entity
@Getter
@Setter
@NoArgsConstructor(access = AccessLevel.PROTECTED)
@ToString(of = {"id", "username", "age"})
**@NamedQuery(
        name="Member.findByUsername",
        query="select m from Member m where m.username = :username"
)
public class Member {**

    @Id @GeneratedValue
    private Long id;
    private String username;
    private int age;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "team_id")
    private Team team;

    public Member(String username) {
        this.username = username;
    }

    public Member(String username, int age, Team team) {
        this.username = username;
        this.age = age;
        if (team != null) {
            changeTeam(team);
        }
    }

    public Member(String username, int age) {
        this.username = username;
        this.age = age;
    }

    public void changeTeam(Team team) {
        this.team = team;
        team.getMembers().add(this);
    }

}
```

**JPAë¥¼ ì§ì ‘ ì‚¬ìš©í•´ì„œ Named ì¿¼ë¦¬ í˜¸ì¶œ - MemberJpaRepository**

```java
public List<Member> findByUsername(String username) {
    List<Member> resultList = em.createNamedQuery("Member.findByUsername", Member.class)
            .setParameter("username", username)
            .getResultList();
    return resultList;
}
```

**ìŠ¤í”„ë§ ë°ì´í„° JPAë¡œ NamedQuery ì‚¬ìš©**

```java
@Query(name = "Member.findByUsername")
List<Member> findByUsername(@Param("username") String username);
```

`@Query`ë¥¼ ìƒëµí•˜ê³  ë©”ì„œë“œ ì´ë¦„ë§Œìœ¼ë¡œ Named ì¿¼ë¦¬ë¥¼ í˜¸ì¶œí•  ìˆ˜ ìˆë‹¤.

**ìŠ¤í”„ë§ ë°ì´í„° JPAë¡œ Named ì¿¼ë¦¬ í˜¸ì¶œ**

```java
package study.datajpa.repository;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.repository.query.Param;
import study.datajpa.entity.Member;

import java.util.List;

public interface MemberRepository extends JpaRepository<Member, Long> {  //** ì—¬ê¸° ì„ ì–¸í•œ Member ë„ë©”ì¸ í´ë˜ìŠ¤

    List<Member> findByUsernameAndAgeGreaterThan(String username, int age);

    List<Member> findByUsername(@Param("username") String username);

}
```

- ìŠ¤í”„ë§ ë°ì´í„° JPAëŠ” ì„ ì–¸í•œ â€œë„ë©”ì¸ í´ë˜ìŠ¤ + .(ì ) + ë©”ì„œë“œ ì´ë¦„â€ìœ¼ë¡œ Named ì¿¼ë¦¬ë¥¼ ì°¾ì•„ì„œ ì‹¤í–‰
- ë§Œì•½ ì‹¤í–‰í•  Named ì¿¼ë¦¬ê°€ ì—†ìœ¼ë©´ ë©”ì„œë“œ ì´ë¦„ìœ¼ë¡œ ì¿¼ë¦¬ ìƒì„± ì „ëµì„ ì‚¬ìš©í•œë‹¤.
- í•„ìš”í•˜ë©´ ì „ëµì„ ë³€ê²½í•  ìˆ˜ ìˆì§€ë§Œ ê¶Œì¥í•˜ì§€ ì•ŠëŠ”ë‹¤.
    
    ì°¸ê³  ğŸ‘‡
    
    [Spring Data JPA - Reference Documentation](https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#repositories.query-methods.query-lookup-strategies)
    

> ğŸ’¡ì°¸ê³  : ìŠ¤í”„ë§ ë°ì´í„° JPAë¥¼ ì‚¬ìš©í•˜ë©´ ì‹¤ë¬´ì—ì„œ Named Queryë¥¼ ì§ì ‘ ë“±ë¡í•´ì„œ ì‚¬ìš©í•˜ëŠ” ì¼ì€ ë“œë¬¼ë‹¤. ëŒ€ì‹  `@Query`ë¥¼ ì‚¬ìš©í•´ì„œ ë¦¬íŒŒì§€í† ë¦¬ ë©”ì†Œë“œì— ì¿¼ë¦¬ë¥¼ ì§ì ‘ ì •ì˜í•œë‹¤.
> 

## @Query, ë¦¬í¬ì§€í† ë¦¬ ë©”ì†Œë“œì— ì¿¼ë¦¬ ì •ì˜í•˜ê¸°

**ë©”ì„œë“œì— JPQL ì¿¼ë¦¬ ì‘ì„±**

```java
package study.datajpa.repository;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import study.datajpa.entity.Member;

import java.util.List;

public interface MemberRepository extends JpaRepository<Member, Long> {

    List<Member> findByUsernameAndAgeGreaterThan(String username, int age);

    List<Member> findByUsername(@Param("username") String username);

    @Query("select m from Member m where m.username = :username and m.age = :age")
    List<Member> findUser(@Param("username") String username, @Param("age") int age);

}
```

- `@org.springframework.data.jpa.repository.Query` ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©
- ì‹¤í–‰í•  ë©”ì„œë“œì— ì •ì  ì¿¼ë¦¬ë¥¼ ì§ì ‘ ì‘ì„±í•˜ë¯€ë¡œ ì´ë¦„ ì—†ëŠ” Named ì¿¼ë¦¬ë¼ í•  ìˆ˜ ìˆìŒ
- JPA Named ì¿¼ë¦¬ì²˜ëŸ¼ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ ì‹œì ì— ë¬¸ë²• ì˜¤ë¥˜ë¥¼ ë°œê²¬í•  ìˆ˜ ìˆìŒ(ë§¤ìš° í° ì¥ì !!!)

> ğŸ’¡Â ì°¸ê³ : ì‹¤ë¬´ì—ì„œëŠ” ë©”ì†Œë“œ ì´ë¦„ìœ¼ë¡œ ì¿¼ë¦¬ ìƒì„± ê¸°ëŠ¥ì€ íŒŒë¼ë¯¸í„°ê°€ ì¦ê°€í•˜ë©´ ë©”ì„œë“œ ì´ë¦„ì´ ë§¤ìš° ì§€ì €ë¶„í•´ì§„ë‹¤. ë”°ë¼ì„œ `@Query` ê¸°ëŠ¥ì„ ìì£¼ ì‚¬ìš©í•˜ê²Œ ëœë‹¤.
> 

## @Query, ê°’, DTO ì¡°íšŒí•˜ê¸°

**ë‹¨ìˆœíˆ ê°’ í•˜ë‚˜ë¥¼ ì¡°íšŒ**

```java
@Query("select m.username from Member m")
List<String> findUsernameList();
```

JPAê°’ íƒ€ì…(`@Embedded`)ë„ ì´ ë°©ì‹ìœ¼ë¡œ ì¡°íšŒí•  ìˆ˜ ìˆë‹¤.

**DTOë¡œ ì§ì ‘ ì¡°íšŒ**

```java
@Query("select new study.datajpa.repository.MemberDto(m.id, m.username, t.name) " +
            "from Member m join m.team t")
List<MemberDto> findMemberDto();
```

âš ï¸Â ì£¼ì˜! DTOë¡œ ì§ì ‘ ì¡°íšŒ í•˜ë ¤ë©´ JPAì˜ `new` ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤. ê·¸ë¦¬ê³  ë‹¤ìŒê³¼ ê°™ì´ ìƒì„±ìê°€ ë§ëŠ” DTOê°€ í•„ìš”í•˜ë‹¤. (JPAì™€ ì‚¬ìš©ë°©ì‹ì´ ë™ì¼í•˜ë‹¤.)

```java
package study.datajpa.repository;

import lombok.Data;

@Data
public class MemberDto {
    private Long id;
    private String username;
    private String teamName;

    public MemberDto(Long id, String username, String teamName) {
        this.id = id;
        this.username = username;
        this.teamName = teamName;
    }
}
```

## íŒŒë¼ë¯¸í„° ë°”ì¸ë”©

- ìœ„ì¹˜ ê¸°ë°˜
- ì´ë¦„ ê¸°ë°˜

```java
select m from Member m where m.username = ?0 //ìœ„ì¹˜ ê¸°ë°˜ 
select m from Member m where m.username = :name //ì´ë¦„ ê¸°ë°˜
```

**íŒŒë¼ë¯¸í„° ë°”ì¸ë”©**

```java
@Query("select m from Member m where m.username = :name")
Member findMembers(@Param("name") String username);
```

ğŸ’¡ì½”ë“œ ê°€ë…ì„±ê³¼ ìœ ì§€ë³´ìˆ˜ë¥¼ ìœ„í•´ ì´ë¦„ ê¸°ë°˜ íŒŒë¼ë¯¸í„° ë°”ì¸ë”©ì„ ì‚¬ìš©í•˜ì(ìœ„ì¹˜ê¸°ë°˜ì€ ìˆœì„œ ì‹¤ìˆ˜ê°€ ë°”ê¾¸ë©´ ë¬¸ì œê°€ ë°œìƒí•œë‹¤.)

**ì»¬ë ‰ì…˜ íŒŒë¼ë¯¸í„° ë°”ì¸ë”©**

`Collection` íƒ€ì…ìœ¼ë¡œ inì ˆ ì§€ì›

```java
@Query("select m from Member m where m.username in :names")
List<Member> findByNames(@Param("names") List<String> names);
```

## ë°˜í™˜ íƒ€ì…

ìŠ¤í”„ë§ ë°ì´í„° JPAëŠ” ìœ ì—°í•œ ë°˜í™˜ íƒ€ì… ì§€ì›

```java
List<Member> findByUsername(String name); //ì»¬ë ‰ì…˜ 
Member findByUsername(String name); //ë‹¨ê±´
Optional<Member> findByUsername(String name); //ë‹¨ê±´ Optional
```

ğŸ’¡Â ìŠ¤í”„ë§ ë°ì´í„° JPA ê³µì‹ ë¬¸ì„œ

[Spring Data JPA - Reference Documentation](https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#repository-query-return-types)

**ì¡°íšŒ ê²°ê³¼ê°€ ë§ê±°ë‚˜ ì—†ìœ¼ë©´?**

- ì»¬ë ‰ì…˜
    - ê²°ê³¼ ì—†ìŒ: ë¹ˆ ì»¬ë ‰ì…˜ ë°˜í™˜
- ë‹¨ê±´ ì¡°íšŒ
    - ê²°ê³¼ ì—†ìŒ: `null` ë°˜í™˜
    - ê²°ê³¼ê°€ 2ê±´ ì´ìƒ : `javax.persistence.NonUniqueResultException` ì˜ˆì™¸ ë°œìƒ

> ğŸ’¡Â ì°¸ê³  : ë‹¨ê±´ìœ¼ë¡œ ì§€ì •í•œ ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ë©´ ìŠ¤í”„ë§ ë°ì´í„° JPAëŠ” ë‚´ë¶€ì—ì„œ JPQLì˜ `Query.getSingleResult()` ë©”ì„œë“œë¥¼ í˜¸ì¶œí•œë‹¤. ì´ ë©”ì„œë“œë¥¼ í˜¸ì¶œí–ˆì„ ë•Œ ì¡°íšŒ ê²°ê³¼ê°€ ì—†ìœ¼ë©´ `javax.persistence.NoResultException` ì˜ˆì™¸ê°€ ë°œìƒí•˜ëŠ”ë° ê°œë°œì ì…ì¥ì—ì„œ ë‹¤ë£¨ê¸°ê°€ ìƒë‹¹íˆ ë¶ˆí¸í•˜ë‹¤. ìŠ¤í”„ë§ ë°ì´í„° JPAëŠ” ë‹¨ê±´ì„ ì¡°íšŒí•  ë•Œ ì´ ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´ ì˜ˆì™¸ë¥¼ ë¬´ì‹œí•˜ê³  ëŒ€ì‹ ì— `null`ì„ ë°˜í™˜í•œë‹¤.
> 

## ìˆœìˆ˜ JPA í˜ì´ì§•ê³¼ ì •ë ¬

JPAì—ì„œ í˜ì´ì§•ì„ ì–´ë–»ê²Œ í•  ê²ƒì¸ê°€?

ë‹¤ìŒ ì¡°ê±´ìœ¼ë¡œ í˜ì´ì§•ê³¼ ì •ë ¬ì„ ì‚¬ìš©í•˜ëŠ” ì˜ˆì œ ì½”ë“œë¥¼ ë³´ì.

- ê²€ìƒ‰ ì¡°ê±´ : ë‚˜ì´ê°€ 10ì‚´
- ì •ë ¬ ì¡°ê±´ : ì´ë¦„ìœ¼ë¡œ ë‚´ë¦¼ì°¨ìˆœ
- í˜ì´ì§• ì¡°ê±´ : ì²« ë²ˆì§¸ í˜ì´ì§€, í˜ì´ì§€ë‹¹ ë³´ì—¬ì¤„ ë°ì´í„°ëŠ” 3ê±´

**JPA í˜ì´ì§• ë¦¬í¬ì§€í† ë¦¬ ì½”ë“œ -** `MemberJpaRepository`

```java
public List<Member> findByPage(int age, int offset, int limit) {
    return em.createQuery("select m from Member m where m.age = :age order by m.username desc")
            .setParameter("age", age)
            .setFirstResult(offset)
            .setMaxResults(limit)
            .getResultList();
}

public long totalCount(int age) {
    return em.createQuery("select count(m) from Member m where m.age = :age", Long.class)
            .setParameter("age", age)
            .getSingleResult();
}
```

**JPA í˜ì´ì§• í…ŒìŠ¤íŠ¸ ì½”ë“œ -**`MemberJpaRepositoryTest`

```java
@Test
    public void paging() throws Exception {
        //given
        memberJpaRepository.save(new Member("member1", 10));
        memberJpaRepository.save(new Member("member2", 10));
        memberJpaRepository.save(new Member("member3", 10));
        memberJpaRepository.save(new Member("member4", 10));
        memberJpaRepository.save(new Member("member5", 10));

        int age = 10;
        int offset = 0;
        int limit = 3;
        
        //when
        List<Member> members = memberJpaRepository.findByPage(age, offset, limit);
        long totalCount = memberJpaRepository.totalCount(age);
        
        //í˜ì´ì§€ ê³„ì‚° ê³µì‹ ì ìš©...
        //totalPage = totalCount / size ...
        //ë§ˆì§€ë§‰ í˜ì´ì§€ ...
        //ìµœì´ˆ í˜ì´ì§€ ..
        
        //then
        assertThat(members.size()).isEqualTo(3);
        assertThat(totalCount).isEqualTo(5);
        
    }
```

## ìŠ¤í”„ë§ ë°ì´í„° JPA í˜ì´ì§•ê³¼ ì •ë ¬

**í˜ì´ì§•ê³¼ ì •ë ¬ íŒŒë¦¬ë¯¸í„°**

- `org.springframework.data.domain.Sort` : ì •ë ¬ ê¸°ëŠ¥
- `org.springframework.data.domain.Pageable` : í˜ì´ì§• ê¸°ëŠ¥ (ë‚´ë¶€ì— `Sort` í¬í•¨)

íŠ¹ë³„í•œ ë°˜í™˜ íƒ€ì…

- `org.springframework.data.domain.Page` : ì¶”ê°€ count ì¿¼ë¦¬ ê²°ê³¼ë¥¼ í¬í•¨í•˜ëŠ” í˜ì´ì§•
- `org.springframework.data.domain.Slice` : ì¶”ê°€ count ì¿¼ë¦¬ ì—†ì´ ë‹¤ìŒ í˜ì´ì§€ë§Œ í™•ì¸ ê°€ëŠ¥(ë‚´ë¶€ì ìœ¼ë¡œ limit + 1ì¡°íšŒ)
- `List`(ìë°” ì»¬ë ‰ì…˜): ì¶”ê°€ count ì¿¼ë¦¬ ì—†ì´ ê²°ê³¼ë§Œ ë°˜í™˜

**í˜ì´ì§•ê³¼ ì •ë ¬ ì‚¬ìš© ì˜ˆì œ**

```java
Page<Member> findByUsername(String name, Pageable pageable); //count ì¿¼ë¦¬ ì‚¬ìš© 
Slice<Member> findByUsername(String name, Pageable pageable); //count ì¿¼ë¦¬ ì‚¬ìš© ì•ˆ í•¨
List<Member> findByUsername(String name, Pageable pageable); //count ì¿¼ë¦¬ ì‚¬ìš© ì•ˆ í•¨
List<Member> findByUsername(String name, Sort sort);
```

ë‹¤ìŒ ì¡°ê±´ìœ¼ë¡œ í˜ì´ì§•ê³¼ ì •ë ¬ì„ ì‚¬ìš©í•˜ëŠ” ì˜ˆì œ ì½”ë“œë¡œ ë³´ì.

- ê²€ìƒ‰ ì¡°ê±´: ë‚˜ì´ê°€ 10ì‚´
- ì •ë ¬ ì¡°ê±´ : ì´ë¦„ìœ¼ë¡œ ë‚´ë¦¼ì°¨ìˆœ
- í˜ì´ì§• ì¡°ê±´ : ì²« ë²ˆì§¸ í˜ì´ì§€, í˜ì´ì§€ë‹¹ ë³´ì—¬ì¤„ ë°ì´í„°ëŠ” 3ê±´

**Page ì‚¬ìš© ì˜ˆì œ ì •ì˜ ì½”ë“œ**

```java
package study.datajpa.repository;

import org.springframework.data.domain.Page;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import study.datajpa.entity.Member;

import java.awt.print.Pageable;
import java.util.List;

public interface MemberRepository extends JpaRepository<Member, Long> {

    ...

    Page<Member> findByAge(int age, Pageable pageable);

}
```

**Page ì‚¬ìš© ì˜ˆì œ ì‹¤í–‰ ì½”ë“œ - MemberRepositoryTest**

```java
//í˜ì´ì§• ì¡°ê±´ê³¼ ì •ë ¬ ì¡°ê±´ ì„¤ì •
public void page() throws Exception {
    //given
    memberRepository.save(new Member("member1", 10));
    memberRepository.save(new Member("member2", 10));
    memberRepository.save(new Member("member3", 10));
    memberRepository.save(new Member("member4", 10));
    memberRepository.save(new Member("member5", 10));

    //when
    PageRequest pageRequest = PageRequest.of(0, 3, Sort.by(Sort.Direction.DESC, "username"));
    Page<Member> page = memberRepository.findByAge(10, (Pageable) pageRequest);

    //then
    List<Member> content = page.getContent();//ì¡°íšŒëœ ë°ì´í„°
    assertThat(content.size()).isEqualTo(3);  //ì¡°íšŒëœ ë°ì´í„° ìˆ˜
    assertThat(page.getTotalElements()).isEqualTo(5);  //ì „ì²´ ë°ì´í„° ìˆ˜
    assertThat(page.getNumber()).isEqualTo(0);  //í˜ì´ì§€ ë²ˆí˜¸
    assertThat(page.getTotalPages()).isEqualTo(2);  //ì „ì²´ í˜ì´ì§€ ë²ˆí˜¸
    assertThat(page.isFirst()).isTrue();  //ì²«ë²ˆì§¸ í•­ëª©ì¸ê°€?
    assertThat(page.hasNext()).isTrue();  //ë‹¤ìŒ í˜ì´ì§€ê°€ ìˆëŠ”ê°€?
}
```

- ë‘ ë²ˆì§¸ íŒŒë¼ë¯¸í„°ë¡œ ë°›ì€ `Pageable`ì€ ì¸í„°í˜ì´ìŠ¤ë‹¤. ë”°ë¼ì„œ ì‹¤ì œ ì‚¬ìš©í•  ë•ŒëŠ” í•´ë‹¹ ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•œ `org.springframework.data.domain.PageRequest` ê°ì²´ë¥¼ ì‚¬ìš©í•œë‹¤.
- `PageRequest` ìƒì„±ìì˜ ì²« ë²ˆì§¸ íŒŒë¼ë¯¸í„°ì—ëŠ” í˜„ì¬ í˜ì´ì§€ë¥¼, ë‘ ë²ˆì§¸ íŒŒë¼ë¯¸í„°ì—ëŠ” ì¡°íšŒí•  ë°ì´í„° ìˆ˜ë¥¼ ì…ë ¥í•œë‹¤. ì—¬ê¸°ì— ì¶”ê°€ë¡œ ì •ë ¬ ì •ë³´ë„ íŒŒë¼ë¯¸í„°ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤. ì°¸ê³ ë¡œ í˜ì´ì§€ëŠ” 0ë¶€í„° ì‹œì‘í•œë‹¤.

**Page ì¸í„°í˜ì´ìŠ¤**

```java
public interface Page<T> extends Slice<T> {
		int getTotalPages(); //ì „ì²´ í˜ì´ì§€ ìˆ˜
		long getTotalElements(); //ì „ì²´ ë°ì´í„° ìˆ˜
		<U> Page<U> map(Function<? super T, ? extends U> converter); //ë³€í™˜ê¸°
}
```

**Slice ì¸í„°í˜ì´ìŠ¤**

```java
public interface Slice<T> extends Streamable<T> {
		int getNumber();                //í˜„ì¬ í˜ì´ì§€
		int getSize();                  //í˜ì´ì§€ í¬ê¸°
		int getNumberOfElements();      //í˜„ì¬ í˜ì´ì§€ì— ë‚˜ì˜¬ ë°ì´í„° ìˆ˜
		List<T> getContent();           //ì¡°íšŒëœ ë°ì´í„°
		boolean hasContent();           //ì¡°íšŒëœ ë°ì´í„° ì¡´ì¬ ì—¬ë¶€
		Sort getSort();                 //ì •ë ¬ ì •ë³´
		boolean isFirst();              //í˜„ì¬ í˜ì´ì§€ê°€ ì²« í˜ì´ì§€ ì¸ì§€ ì—¬ë¶€
		boolean isLast();               //í˜„ì¬ í˜ì´ì§€ê°€ ë§ˆì§€ë§‰ í˜ì´ì§€ ì¸ì§€ ì—¬ë¶€
		boolean hasNext();              //ë‹¤ìŒ í˜ì´ì§€ ì—¬ë¶€
		boolean hasPrevious();          //ì´ì „ í˜ì´ì§€ ì—¬ë¶€
		Pageable getPageable();         //í˜ì´ì§• ìš”ì²­ ì •ë³´
		Pageable nextPageable();        //ë‹¤ìŒ í˜ì´ì§€ ê°ì²´
		Pageable previousPageable();    //ì´ì „ í˜ì´ì§€ ê°ì²´
		<U> Slice<U> map(Function<? super T, ? extends U> converter); //ë³€í™˜ê¸°
}
```

ğŸ’¡Â ì°¸ê³ : count ì¿¼ë¦¬ë¥¼ ë‹¤ìŒê³¼ ê°™ì´ ë¶„ë¦¬í•  ìˆ˜ ìˆìŒ

```java
@Query(value = â€œselect m from Member mâ€,
       countQuery = â€œselect count(m.username) from Member mâ€)
Page<Member> findMemberAllCountBy(Pageable pageable);
```

**Top, First ì‚¬ìš© ì°¸ê³ **

[Spring Data JPA - Reference Documentation](https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#repositories.limit-query-result)

`List<Member> findTop3By();`

**í˜ì´ì§€ë¥¼ ìœ ì§€í•˜ë©´ì„œ ì—”í‹°í‹°ë¥¼ DTOë¡œ ë³€í™˜í•˜ê¸° - MemberRepositoryTest**

```java
Page<Member> page = memberRepository.findByAge(10, pageRequest);
Page<MemberDto> dtoPage = page.map(m -> new MemberDto());
```

ì‹¤ìŠµ

- Page
- Slice (count X) ì¶”ê°€ë¡œ limit + 1ì„ ì¡°íšŒí•œë‹¤. ê·¸ë˜ì„œ ë‹¤ìŒ í˜ì´ì§€ ì—¬ë¶€ í™•ì¸(ìµœê·¼ ëª¨ë°”ì¼ ë¦¬ìŠ¤íŠ¸ ìƒê°í•´ë³´ë©´ ë¨)
- List (countX)
- ì¹´ìš´íŠ¸ ì¿¼ë¦¬ ë¶„ë¦¬(ì´ê±´ ë³µì¡í•œ sqlì—ì„œ ì‚¬ìš©, ë°ì´í„°ëŠ” left join, ì¹´ìš´íŠ¸ëŠ” left join ì•ˆí•´ë„ ë¨) â†’ ì‹¤ë¬´ì—ì„œ ë§¤ìš° ì¤‘ìš” â£ï¸

â£ï¸Â ì „ì²´ count ì¿¼ë¦¬ëŠ” ë§¤ìš° ë¬´ê²ë‹¤.

## ë²Œí¬ì„± ìˆ˜ì • ì¿¼ë¦¬

**JPAë¥¼ ì‚¬ìš©í•œ ë²Œí¬ì„± ìˆ˜ì • ì¿¼ë¦¬ -** `MemberJpaRepository`

```java
public int bulkAgePlus(int age) {
    int resultCount = em.createQuery(
                    "update Member m set m.age = m.age + 1" +
                            "where m.age >= :age")
            .setParameter("age", age)
            .executeUpdate();

    return resultCount;
}
```

**JPAë¥¼ ì‚¬ìš©í•œ ë²Œí¬ì„± ìˆ˜ì • ì¿¼ë¦¬ í…ŒìŠ¤íŠ¸ -** `MemberJpaRepositoryTest`

```java
@Test
public void bulkUpdate() throws Exception {
    //given
    memberJpaRepository.save(new Member("member1", 10));
    memberJpaRepository.save(new Member("member2", 10));
    memberJpaRepository.save(new Member("member3", 10));
    memberJpaRepository.save(new Member("member4", 10));
    memberJpaRepository.save(new Member("member5", 10));

    //when
    int resultCount = memberJpaRepository.bulkAgePlus(20);

    //then
    assertThat(resultCount).isEqualTo(3);
}
```

**ìŠ¤í”„ë§ ë°ì´í„° JPAë¥¼ ì‚¬ìš©í•œ ë²Œí¬ì„± ìˆ˜ì • ì¿¼ë¦¬ -** *`MemberRepository`*

```java
@Modifying
@Query("update Member m set m.age = m.age +1 where m.age >= :age")
int bulkAgePlus(@Param("age") int age);
```

**ìŠ¤í”„ë§ ë°ì´í„° JPAë¥¼ ì‚¬ìš©í•œ ë²Œí¬ì„± ìˆ˜ì • ì¿¼ë¦¬ í…ŒìŠ¤íŠ¸ -** *`MemberRepositoryTest`*

```java
@Test
public void bulkUpdate() throws Exception {
    //given
    memberRepository.save(new Member("member1", 10));
    memberRepository.save(new Member("member2", 10));
    memberRepository.save(new Member("member3", 10));
    memberRepository.save(new Member("member4", 10));
    memberRepository.save(new Member("member5", 10));

    //when
    int resultCount = memberRepository.bulkAgePlus(20);

    //then
    assertThat(resultCount).isEqualTo(3);
}
```

- ë²Œí¬ì„± ìˆ˜ì •, ì‚­ì œ ì¿¼ë¦¬ëŠ” `@Modifying` ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©
    - ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©´ ë‹¤ìŒ ì˜ˆì™¸ ë°œìƒ
    - `org.hibernate.hql.internal.QueryExecutionRequestException: Not supported for DML operations`
- ë²Œí¬ì„± ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•˜ê³  ë‚˜ì„œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™” : `@Modifying(clearAutomatically = true)` (ì´ ì˜µì…˜ì˜ ê¸°ë³¸ê°’ì€ `false`)
    - ì´ ì˜µì…˜ ì—†ì´ íšŒì›ì„ `findById`ë¡œ ë‹¤ì‹œ ì¡°íšŒí•˜ë©´ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ê³¼ê±° ê°’ì´ ë‚¨ì•„ì„œ ë¬¸ì œê°€ ë  ìˆ˜ ìˆë‹¤. ë§Œì•½ ë‹¤ì‹œ ì¡°íšŒí•´ì•¼ í•˜ë©´ ê¼­ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì´ˆê¸°í™” í•˜ì.

> ğŸ’¡Â ì°¸ê³  : ë²Œí¬ ì—°ì‚°ì€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ë¬´ì‹œí•˜ê³  ì‹¤í–‰í•˜ê¸° ë•Œë¬¸ì—, ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ìˆëŠ” ì—”í‹°í‹°ì˜ ìƒíƒœì™€ DBì— ì—”í‹°í‹° ìƒíƒœê°€ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆë‹¤.
> 

ê¶Œì¥í•˜ëŠ” ë°©ì•ˆ

1. ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì—”í‹°í‹°ê°€ ì—†ëŠ” ìƒíƒœì—ì„œ ë²Œí¬ ì—°ì‚°ì„ ë¨¼ì € ì‹¤í–‰í•œë‹¤.
2. ë¶€ë“ì´í•˜ê²Œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì—”í‹°í‹°ê°€ ìˆìœ¼ë©´ ë²Œí¬ ì—°ì‚° ì§í›„ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì´ˆê¸°í™” í•œë‹¤.

## @EntityGraph

ì—°ê´€ëœ ì—”í‹°í‹°ë“¤ì„ SQL í•œë²ˆì— ì¡°íšŒí•˜ëŠ” ë°©ë²•

member â†’ teamì€ ì§€ì—°ë¡œë”© ê´€ê³„ì´ë‹¤. ë”°ë¼ì„œ ë‹¤ìŒê³¼ ê°™ì´ teamì˜ ë°ì´í„°ë¥¼ ì¡°íšŒí•  ë•Œ ë§ˆë‹¤ ì¿¼ë¦¬ê°€ ì‹¤í–‰ëœë‹¤. (N+1 ë¬¸ì œ ë°œìƒ)

```java
class MemberRepositoryTest {

    @PersistenceContext
    private EntityManager em;

		...

		@Test
		public void findMemberLazy() throws Exception {
		    //given
		    //member1 -> teamA
		    //member2 -> teamB
		    Team teamA = new Team("teamA");
		    Team teamB = new Team("teamB");
		    teamRepository.save(teamA);
		    teamRepository.save(teamB);
		    memberRepository.save(new Member("member1", 10));
		    memberRepository.save(new Member("member2", 10));
		
		    em.flush();
		    em.clear();
		
		    //when
		    List<Member> members = memberRepository.findAll();
		
		    //then
		    for (Member member : members) {
		        member.getTeam().getName();
		    }
		}

}
```

ğŸ’¡ì°¸ê³  : ë‹¤ìŒê³¼ ê°™ì´ ì§€ì—° ë¡œë”© ì—¬ë¶€ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

```java
//Hibernate ê¸°ëŠ¥ìœ¼ë¡œ í™•ì¸
Hibernate.isInitialized(member.getTeam())

//JPA í‘œì¤€ ë°©ë²•ìœ¼ë¡œ í™•ì¸
PersistenceUnitUtil util = em.getEntityManagerFactory().getPersistenceUnitUtil(); 
util.isLoaded(member.getTeam());
```

ì—°ê´€ëœ ì—”í‹°í‹°ë¥¼ í•œë²ˆì— ì¡°íšŒí•˜ë ¤ë©´ í˜ì¹˜ ì¡°ì¸ì´ í•„ìš”í•˜ë‹¤.

**JPQL í˜ì¹˜ ì¡°ì¸ -** *`MemberRepository`*

```java
@Query("select m from Member m left join fetch m.team")
List<Member> findMemberFetchJoin();
```

ìŠ¤í”„ë§ ë°ì´í„° JPAëŠ” JPAê°€ ì œê³µí•˜ëŠ” ì—”í‹°í‹° ê·¸ë˜í”„ ê¸°ëŠ¥ì„ í¸ë¦¬í•˜ê²Œ ì‚¬ìš©í•˜ê²Œ ë„ì™€ì¤€ë‹¤. ì´ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë©´ JPQL ì—†ì´ í˜ì¹˜ ì¡°ì¸ì„ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤. (JPQL + ì—”í‹°í‹° ê·¸ë˜í”„ë„ ê°€ëŠ¥)

**EntityGraph -** *`MemberRepository`*

```java
//ê³µí†µ ë©”ì„œë“œ ì˜¤ë²„ë¼ì´ë“œ
@Override
@EntityGraph(attributePaths = {"team"})
List<Member> findAll();

//JPQL + ì—”í‹°í‹° ê·¸ë˜í”„
@EntityGraph(attributePaths = {"team"})
@Query("select m from Member m")
List<Member> findMemberEntityGraph();

//ë©”ì„œë“œ ì´ë¦„ìœ¼ë¡œ ì¿¼ë¦¬ì—ì„œ íŠ¹íˆ í¸ë¦¬í•˜ë‹¤.
@EntityGraph(attributePaths = {"team"})
List<Member> findByUsername(String username);
```

**EntityGraph ì •ë¦¬**

- ì‚¬ì‹¤ìƒ í˜ì¹˜ ì¡°ì¸(FETCH JOIN)ì˜ ê°„í¸ ë²„ì „
- LEFT OUTER JOIN ì‚¬ìš©

**NamedEntityGraph ì‚¬ìš© ë°©ë²• -** *`MemberRepository`*

```java
@NamedEntityGraph(name = "Member.all", attributeNodes =
@NamedAttributeNode("team"))
@Entity
public class Member {}
```

```java
@EntityGraph("Member.all")
@Query("select m from Member m")
List<Member> findMemberEntityGraph();
```

## JPA Hint & Lock

**JPA Hint**

JPA ì¿¼ë¦¬ íŒíŠ¸(SQL íŒíŠ¸ê°€ ì•„ë‹ˆë¼ JPA êµ¬í˜„ì²´ì—ê²Œ ì œê³µí•˜ëŠ” íŒíŠ¸)

**ì¿¼ë¦¬ íŒíŠ¸ ì‚¬ìš© -** *`MemberRepository`*

```java
@QueryHints(value = @QueryHint(name = "org.hibernate.readOnly", value = "true"))
Member findReadOnlyByUsername(String username);
```

**ì¿¼ë¦¬ íŒíŠ¸ ì‚¬ìš© í™•ì¸ - *`MemberRepositoryTest`***

```java
@Test
public void queryHint() throws Exception {

    //given
    memberRepository.save(new Member("member1", 10));
    em.flush();
    em.clear();

    //when
    Member member = memberRepository.findReadOnlyByUsername("member1");
    member.setUsername("member2");

    em.flush(); //Update Query ì‹¤í–‰ X
}
```

**ì¿¼ë¦¬ íŒíŠ¸ Page ì¶”ê°€ ì˜ˆì œ -** *`MemberRepository`*

```java
@QueryHints(value = {@QueryHint(name = "org.hibernate.readOnly", value = "true")}, forCounting = true)
Page<Member> findByUsername(String name, Pageable pageable);
```

- `org.springframework.data.jpa.repository.QueryHints` ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©
- `forCounting`: ë°˜í™˜ íƒ€ì…ìœ¼ë¡œ `Page` ì¸í„°í˜ì´ìŠ¤ë¥¼ ì ìš©í•˜ë©´ ì¶”ê°€ë¡œ í˜¸ì¶œí•˜ëŠ” í˜ì´ì§•ì„ ìœ„í•œ count ì¿¼ë¦¬ë„ ì¿¼ë¦¬ íŒíŠ¸ ì ìš©(ê¸°ë³¸ê°’ `true`)

**Lock**

```java
@Lock(LockModeType.PESSIMISTIC_WRITE)
List<Member> findByUsername(String name);
```

- `org.springframework.data.jpa.repository.Lock` ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©
- JPAê°€ ì œê³µí•˜ëŠ” ë½ì€ JPA ì±… 16.1 íŠ¸ëœì­ì…˜ê³¼ ë½ ì ˆì„ ì°¸ê³ 